---
  - hosts: secretsvid
    vars_files:
      - '../vars/vault.yaml'
    roles:
      - role: grog.package
      - role: geerlingguy.docker
      - role: geerlingguy.pip
      - role: ironicbadger.bash_aliases
      - role: ironicbadger.docker_compose_generator
        tags: compose
    tasks:
      - name: start docker containers
        tags: compose
        community.docker.docker_compose:
          state: present
          pull: true
          project_src: "/root"
      - name: create docker-user
        ansible.builtin.user:
          name: docker-user
          shell: /bin/bash
          groups: docker,sudo
          append: yes
          password: "{{ 'password' | password_hash('sha512') }}"
          update_password: on_create
        register: docker-user
      - name: force docker-user to change password
        shell: chage -d 0 docker-user
        when: docker-user.changed
      - name: add docker-user ssh public key
        ansible.posix.authorized_key:
          user: docker-user
          state: present
          key: "{{ lookup('file', '/home/lurch/.ssh/github.pub') }}"

